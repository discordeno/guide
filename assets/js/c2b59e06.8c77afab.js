"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[862],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return h}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=u(n),h=o,m=d["".concat(l,".").concat(h)]||d[h]||p[h]||a;return n?r.createElement(m,s(s({ref:t},c),{},{components:n})):r.createElement(m,s({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,s=new Array(a);s[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var u=2;u<a;u++)s[u]=n[u];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8698:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return i},contentTitle:function(){return l},metadata:function(){return u},toc:function(){return c},default:function(){return d}});var r=n(7462),o=n(3366),a=(n(7294),n(3905)),s=["components"],i={sidebar_position:2,sidebar_label:"Step 1 - REST"},l="Creating A Standalone REST Process",u={unversionedId:"big-bot-guide/rest",id:"big-bot-guide/rest",title:"Creating A Standalone REST Process",description:"The first thing we want to make is our standalone REST process. This process will be used by almost every other process, so it is going to be the foundation of the bot.",source:"@site/docs/big-bot-guide/rest.md",sourceDirName:"big-bot-guide",slug:"/big-bot-guide/rest",permalink:"/docs/big-bot-guide/rest",editUrl:"https://github.com/discordeno/discordeno/tree/main/site/docs/big-bot-guide/rest.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,sidebar_label:"Step 1 - REST"},sidebar:"tutorialSidebar",previous:{title:"Step By Step Guide",permalink:"/docs/big-bot-guide/step-by-step"},next:{title:"Step 2 - Gateway",permalink:"/docs/big-bot-guide/gateway"}},c=[{value:"Why Use Standalone REST Process?",id:"why-use-standalone-rest-process",children:[],level:2},{value:"Preparations",id:"preparations",children:[],level:2},{value:"Creating Rest Manager",id:"creating-rest-manager",children:[],level:2},{value:"Creating HTTP Listener",id:"creating-http-listener",children:[],level:2}],p={toc:c};function d(e){var t=e.components,n=(0,o.Z)(e,s);return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"creating-a-standalone-rest-process"},"Creating A Standalone REST Process"),(0,a.kt)("p",null,"The first thing we want to make is our standalone REST process. This process will be used by almost every other process, so it is going to be the foundation of the bot."),(0,a.kt)("p",null,"Before, we dive into how, here is a quick summary of why you will want a standalone REST process."),(0,a.kt)("h2",{id:"why-use-standalone-rest-process"},"Why Use Standalone REST Process?"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Easily host on any serverless infrastructure."),(0,a.kt)("li",{parentName:"ul"},"Freedom from global rate limit errors",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"As your bot grows, you want to handle global rate limits better. Shards\ndon't communicate fast enough to truly handle it properly so this allows 1\nrest handler across the entire bot."),(0,a.kt)("li",{parentName:"ul"},"In fact, you can host multiple instances of your bot and all connect to the\nsame rest server."))),(0,a.kt)("li",{parentName:"ul"},"REST does not rest!",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Separate rest means if your bot for whatever reason crashes, your requests\nthat are queued will still keep going and will not be lost."),(0,a.kt)("li",{parentName:"ul"},"Seamless updates! When you want to update and reboot the bot, you could\npotentially lose tons of messages or responses that are in queue. Using this\nyou could restart your bot without ever worrying about losing any responses."))),(0,a.kt)("li",{parentName:"ul"},"Single source of contact to Discord API",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"This will allow you to make requests to discord from anywhere including a bot dashboard. You no longer need to have to communicate to your bot processes just to make a request or anything. Free up your bot process for processing bot events."))),(0,a.kt)("li",{parentName:"ul"},"Scalability! Scalability! Scalability!")),(0,a.kt)("h2",{id:"preparations"},"Preparations"),(0,a.kt)("p",null,"Before going further, you should have already made the following pieces:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"src/rest/mod.ts"),(0,a.kt)("li",{parentName:"ul"},"deps.ts (Make sure to import discordeno)"),(0,a.kt)("li",{parentName:"ul"},"configs.ts"),(0,a.kt)("li",{parentName:"ul"},"Deno extension(if you are using deno, this is required)"),(0,a.kt)("li",{parentName:"ul"},"TabNine extension to make your life so much better. (Optional)")),(0,a.kt)("h2",{id:"creating-rest-manager"},"Creating Rest Manager"),(0,a.kt)("p",null,"Now let's open up that rest file and start coding."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'import { DISCORD_TOKEN, REST_AUTHORIZATION, REST_PORT } from "../../configs.ts";\nimport { BASE_URL, createRestManager } from "../../deps.ts";\n\nconst rest = createRestManager({\n  token: DISCORD_TOKEN,\n  secretKey: REST_AUTHORIZATION,\n  customUrl: `http://localhost:${REST_PORT}`,\n});\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"createRestManager")," is imported from your deps file which should have exported everything from discordeno."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"DISCORD_TOKEN")," is the bots token itself."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"REST_AUTHORIZATION")," is a special password you want to use to authenticate that requests being sent to your port are indeed from you."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"customUrl")," the url where this rest process will be running. This can be localhost which we are using in this guide if you want all processes on same VPS or separate them to different servers for horizontal scaling. ",(0,a.kt)("inlineCode",{parentName:"li"},"REST_PORT")," is just the port where you want the process hosted.")),(0,a.kt)("p",null,"Now you have an entire Rest manager ready and waiting. Only thing you need now, is to listen for requests."),(0,a.kt)("h2",{id:"creating-http-listener"},"Creating HTTP Listener"),(0,a.kt)("p",null,"Since this is not a beginner guide, I am assuming you know already how to create a HTTP listener. There are enough guides on this out there. I will only cover the rough functionality."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// START LISTENING TO THE URL(localhost)\nconst server = Deno.listen({ port: REST_PORT });\nconsole.info(\n  `HTTP webserver running.  Access it at:  http://localhost:${REST_PORT}/`\n);\n\n// Connections to the server will be yielded up as an async iterable.\nfor await (const conn of server) {\n  // In order to not be blocking, we need to handle each connection individually\n  // in its own async function.\n  handleRequest(conn);\n}\n\nasync function handleRequest(conn: Deno.Conn) {\n  // This "upgrades" a network connection into an HTTP connection.\n  const httpConn = Deno.serveHttp(conn);\n  // Each request sent over the HTTP connection will be yielded as an async\n  // iterator from the HTTP connection.\n  for await (const requestEvent of httpConn) {\n    if (\n      !REST_AUTHORIZATION ||\n      REST_AUTHORIZATION !== requestEvent.request.headers.get("AUTHORIZATION")\n    ) {\n      return requestEvent.respondWith(\n        new Response(JSON.stringify({ error: "Invalid authorization key." }), {\n          status: 401,\n        })\n      );\n    }\n\n    const json = (await requestEvent.request.json()) as any;\n\n    // IMPLEMENT ANY ERROR HANDLING HERE IF YOU WOULD LIKE BY WRAPPING THIS IN A CATCH\n\n    // MAKE THE REQUEST TO DISCORD\n    const result = await rest.runMethod(\n      rest,\n      // USE THE SAME METHOD THAT CAME IN. IF DELETE CAME IN WE SEND DELETE OUT\n      requestEvent.request.method as any,\n      // OVERWRITE THE CUSTOM URL WITH DISCORDS BASE URL\n      `${BASE_URL}/v${rest.version}${requestEvent.request.url.substring(\n        rest.customUrl.length\n      )}`,\n      json\n    );\n\n    // RETURN DISCORDS RESPONSE BACK TO THE PROCESS MAKING THE REQUEST\n    if (result) {\n      requestEvent.respondWith(\n        new Response(JSON.stringify(result), {\n          status: 200,\n        })\n      );\n    } else {\n      requestEvent.respondWith(\n        new Response(undefined, {\n          status: 204,\n        })\n      );\n    }\n  }\n}\n')))}d.isMDXComponent=!0}}]);