<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Step 2: Creating A Standalone Gateway Process | Discordeno</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="Docs for Discordeno">
    <meta name="theme-color" content="#7289DA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="og:title" content="Discordeno">
    <meta name="og:description" content="Docs for Discordeno">
    <meta name="og:type" content="website">
    <meta name="og:url" content="https://discordeno.mod.land">
    <meta name="og:image" content="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.1ace810b.css" as="style"><link rel="preload" href="/assets/js/app.aaff8819.js" as="script"><link rel="preload" href="/assets/js/2.249f7f8d.js" as="script"><link rel="preload" href="/assets/js/19.a2ebbb7a.js" as="script"><link rel="prefetch" href="/assets/js/10.7e3e75ea.js"><link rel="prefetch" href="/assets/js/11.070d4f02.js"><link rel="prefetch" href="/assets/js/12.68e83f77.js"><link rel="prefetch" href="/assets/js/13.5bbe5518.js"><link rel="prefetch" href="/assets/js/14.3a6e6256.js"><link rel="prefetch" href="/assets/js/15.1eeda6a0.js"><link rel="prefetch" href="/assets/js/16.a51d5574.js"><link rel="prefetch" href="/assets/js/17.8c103126.js"><link rel="prefetch" href="/assets/js/18.90256cf6.js"><link rel="prefetch" href="/assets/js/20.67545e07.js"><link rel="prefetch" href="/assets/js/21.f122ed57.js"><link rel="prefetch" href="/assets/js/22.eb98d442.js"><link rel="prefetch" href="/assets/js/23.531e8e7a.js"><link rel="prefetch" href="/assets/js/24.8a4cbd96.js"><link rel="prefetch" href="/assets/js/25.ff4ef4c9.js"><link rel="prefetch" href="/assets/js/26.be5f94f6.js"><link rel="prefetch" href="/assets/js/27.aee32ec8.js"><link rel="prefetch" href="/assets/js/28.d77bef13.js"><link rel="prefetch" href="/assets/js/29.8ef7a965.js"><link rel="prefetch" href="/assets/js/3.c9559675.js"><link rel="prefetch" href="/assets/js/30.bec72ff0.js"><link rel="prefetch" href="/assets/js/31.0bab0393.js"><link rel="prefetch" href="/assets/js/32.124622eb.js"><link rel="prefetch" href="/assets/js/4.f8ce14f4.js"><link rel="prefetch" href="/assets/js/5.dfbc315f.js"><link rel="prefetch" href="/assets/js/6.583250aa.js"><link rel="prefetch" href="/assets/js/7.f07480fc.js"><link rel="prefetch" href="/assets/js/8.b433b0bc.js"><link rel="prefetch" href="/assets/js/9.2e08797d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1ace810b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Discordeno</span></a> <div class="links"><!----> <div class="user-settings"><a href="#" class="settings-button"><svg aria-hidden="true" data-prefix="fas" data-icon="cog" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-cog fa-w-16 settings-icon"><path fill="currentColor" d="M444.788 291.1l42.616 24.599c4.867 2.809 7.126 8.618 5.459 13.985-11.07 35.642-29.97 67.842-54.689 94.586a12.016 12.016 0 0 1-14.832 2.254l-42.584-24.595a191.577 191.577 0 0 1-60.759 35.13v49.182a12.01 12.01 0 0 1-9.377 11.718c-34.956 7.85-72.499 8.256-109.219.007-5.49-1.233-9.403-6.096-9.403-11.723v-49.184a191.555 191.555 0 0 1-60.759-35.13l-42.584 24.595a12.016 12.016 0 0 1-14.832-2.254c-24.718-26.744-43.619-58.944-54.689-94.586-1.667-5.366.592-11.175 5.459-13.985L67.212 291.1a193.48 193.48 0 0 1 0-70.199l-42.616-24.599c-4.867-2.809-7.126-8.618-5.459-13.985 11.07-35.642 29.97-67.842 54.689-94.586a12.016 12.016 0 0 1 14.832-2.254l42.584 24.595a191.577 191.577 0 0 1 60.759-35.13V25.759a12.01 12.01 0 0 1 9.377-11.718c34.956-7.85 72.499-8.256 109.219-.007 5.49 1.233 9.403 6.096 9.403 11.723v49.184a191.555 191.555 0 0 1 60.759 35.13l42.584-24.595a12.016 12.016 0 0 1 14.832 2.254c24.718 26.744 43.619 58.944 54.689 94.586 1.667 5.366-.592 11.175-5.459 13.985L444.788 220.9a193.485 193.485 0 0 1 0 70.2zM336 256c0-44.112-35.888-80-80-80s-80 35.888-80 80 35.888 80 80 80 80-35.888 80-80z"></path></svg></a> <div class="user-settings-menu" style="display:none;"><div class="theme-options"><!----> <!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox"></div> <!----> <!----></div></div></div> <!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://doc.deno.land/https/deno.land/x/discordeno/mod.ts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Docs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://discord.gg/5vBgXk3UcZ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/discordeno/guide" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://doc.deno.land/https/deno.land/x/discordeno/mod.ts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Docs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://discord.gg/5vBgXk3UcZ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/discordeno/guide" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Home</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Big Bots Guide</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigbots/" aria-current="page" class="sidebar-link">Step By Step Guide</a></li><li><a href="/bigbots/rest.html" class="sidebar-link">Step 1: Creating A Standalone REST Process</a></li><li><a href="/bigbots/gateway.html" aria-current="page" class="active sidebar-link">Step 2: Creating A Standalone Gateway Process</a></li><li><a href="/bigbots/cache.html" class="sidebar-link">Step 3: Standalone Cache Process</a></li><li><a href="/bigbots/events.html" class="sidebar-link">Step 4: Creating Standalone Event Handler</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Step By Step Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Advanced Guide</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="step-2-creating-a-standalone-gateway-process"><a href="#step-2-creating-a-standalone-gateway-process" class="header-anchor">#</a> Step 2: Creating A Standalone Gateway Process</h1> <p>If you are reading this, you should have your REST process completed. We are going to need it here. This process will be connecting to discord's websockets which will send you all the events.</p> <p>Before, we dive into how, here is a quick summary of why you will want a standalone gateway process.</p> <h2 id="why-use-standalone-rest-process"><a href="#why-use-standalone-rest-process" class="header-anchor">#</a> Why Use Standalone REST Process?</h2> <ul><li><p><strong>Zero Downtime Updates</strong>:</p> <ul><li>Your bot can be updated in a matter of seconds. With normal sharding, you
have to restart which also has to process identifying all your shards with a
1/~5s rate limit. With WS handling moved to a proxy process, this allows you
to instantly get the bot code restarted without any concerns of delays. If
you have a bot on 200,000 servers normally this would mean a 20 minute delay
to restart your bot if you made a small change and restarted.</li></ul></li> <li><p><strong>Zero Downtime Resharding</strong>:</p> <ul><li>Discord stops letting your bot get added to new servers at certain points in
time. For example, suppose you had 150,000 servers running 150 shards. The
maximum amount of servers your shards could hold is 150 * 2500 = 375,000. If
your bot reaches this, it can no longer join new servers until it re-shards.</li> <li>DD proxy provides 2 types of re-sharding. Automated and manual. You can also
have both.
<ul><li><code>Automated</code>: This system will automatically begin a Zero-downtime
resharding process behind the scenes when you reach 80% of your maximum
servers allowed by your shards. For example, since 375,000 was the max, at
300,000 we would begin re-sharding behind the scenes with <code>ZERO DOWNTIME</code>.
<ul><li>80% of maximum servers reached (The % of 80% is customizable.)</li> <li>Identify limits have room to allow re-sharding. (Also customizable)</li></ul></li> <li><code>Manual</code>: You can also trigger this manually should you choose.</li></ul></li></ul></li> <li><p><strong>Horizontal Scaling</strong>:</p> <ul><li>The proxy system allows you to scale the bot horizontally. When you reach a
huge size, you can either keep spending more money to keep beefing up your
server or you can buy several cheaper servers and scale horizontally. The
proxy means you can have WS handling on a completely separate system.</li></ul></li> <li><p><strong>No Loss Restarts</strong>:</p> <ul><li>When you restart a bot without the proxy system, normally you would lose
many events. Users may be using commands or messages are sent that will not
be filtered. As your bot's grow this number rises dramatically. Users may
join who wont get the auto-roles or any other actions your bot should take.
With the proxy system, you can keep restarting your bot and never lose any
events. Events will be put into a queue while your bot is down(max size of
queue is customizable), once the bot is available the queue will begin
processing all events.</li></ul></li> <li><p><strong>Controllers</strong>:</p> <ul><li>The controller aspect gives you full control over everything inside the
proxy. You can provide a function to simply override the handler. For
example, if you would like a certain function to do something different,
instead of having to fork and maintain your fork, you can just provide a
function to override.</li></ul></li> <li><p><strong>Clustering With Workers</strong>:</p> <ul><li>Take full advantage of all your CPU cores by using workers to spread the
load. Control how many shards per worker and how many workers to maximize
efficiency!</li></ul></li></ul> <h2 id="creating-gateway-manager"><a href="#creating-gateway-manager" class="header-anchor">#</a> Creating Gateway Manager</h2> <p>Create a file under some path like <code>src/gateway/mod.ts</code>.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DISCORD_TOKEN</span><span class="token punctuation">,</span> <span class="token constant">REST_AUTHORIZATION</span><span class="token punctuation">,</span> <span class="token constant">REST_PORT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../configs.ts&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">BASE_URL</span><span class="token punctuation">,</span> createRestManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../deps.ts&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> rest <span class="token operator">=</span> <span class="token function">createRestManager</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  token<span class="token operator">:</span> <span class="token constant">DISCORD_TOKEN</span><span class="token punctuation">,</span>
  secretKey<span class="token operator">:</span> <span class="token constant">REST_AUTHORIZATION</span><span class="token punctuation">,</span>
  customUrl<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">REST_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Throw another rest manager here which will be responsible for calling the main REST process we created in Step 1. This will allow your gateway to communicate to the other process. Remember this is just to communicate outwards, this file should not have the http listener.</p> <blockquote><p>Feel free to refactor and optimize this should you wish to move <code>const rest...</code> to a separate file and reuse in both steps.</p></blockquote> <h3 id="getting-gateway-bot-data"><a href="#getting-gateway-bot-data" class="header-anchor">#</a> Getting Gateway Bot Data</h3> <p>Now we need to use this rest manager to call the api to get information about how to connect to discord's gateway for your bot.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> rest <span class="token operator">=</span> <span class="token function">createRestManager</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  token<span class="token operator">:</span> <span class="token constant">DISCORD_TOKEN</span><span class="token punctuation">,</span>
  secretKey<span class="token operator">:</span> <span class="token constant">REST_AUTHORIZATION</span><span class="token punctuation">,</span>
  customUrl<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">REST_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// CALL THE REST PROCESS TO GET GATEWAY DATA</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> rest<span class="token punctuation">.</span><span class="token function">runMethod</span><span class="token punctuation">(</span>rest<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> endpoints<span class="token punctuation">.</span><span class="token constant">GATEWAY_BOT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  url<span class="token operator">:</span> res<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
  shards<span class="token operator">:</span> res<span class="token punctuation">.</span>shards<span class="token punctuation">,</span>
  sessionStartLimit<span class="token operator">:</span> <span class="token punctuation">{</span>
    total<span class="token operator">:</span> res<span class="token punctuation">.</span>session_start_limit<span class="token punctuation">.</span>total<span class="token punctuation">,</span>
    remaining<span class="token operator">:</span> res<span class="token punctuation">.</span>session_start_limit<span class="token punctuation">.</span>remaining<span class="token punctuation">,</span>
    resetAfter<span class="token operator">:</span> res<span class="token punctuation">.</span>session_start_limit<span class="token punctuation">.</span>reset_after<span class="token punctuation">,</span>
    maxConcurrency<span class="token operator">:</span> res<span class="token punctuation">.</span>session_start_limit<span class="token punctuation">.</span>max_concurrency<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>With this info, we can now create our gateway manager.</p> <h3 id="understanding-gateway-manager"><a href="#understanding-gateway-manager" class="header-anchor">#</a> Understanding Gateway Manager</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> gateway <span class="token operator">=</span> <span class="token function">createGatewayManager</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secretKey<span class="token operator">:</span> <span class="token constant">EVENT_HANDLER_SECRET_KEY</span><span class="token punctuation">,</span>
  token<span class="token operator">:</span> <span class="token constant">DISCORD_TOKEN</span><span class="token punctuation">,</span>
  intents<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'GuildMessages'</span><span class="token punctuation">,</span> <span class="token string">'Guilds'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  shardsRecommended<span class="token operator">:</span> result<span class="token punctuation">.</span>shards<span class="token punctuation">,</span>
  sessionStartLimitTotal<span class="token operator">:</span> result<span class="token punctuation">.</span>sessionStartLimit<span class="token punctuation">.</span>total<span class="token punctuation">,</span>
  sessionStartLimitRemaining<span class="token operator">:</span> result<span class="token punctuation">.</span>sessionStartLimit<span class="token punctuation">.</span>remaining<span class="token punctuation">,</span>
  sessionStartLimitResetAfter<span class="token operator">:</span> result<span class="token punctuation">.</span>sessionStartLimit<span class="token punctuation">.</span>resetAfter<span class="token punctuation">,</span>
  maxConcurrency<span class="token operator">:</span> result<span class="token punctuation">.</span>sessionStartLimit<span class="token punctuation">.</span>maxConcurrency<span class="token punctuation">,</span>
  maxShards<span class="token operator">:</span> result<span class="token punctuation">.</span>shards<span class="token punctuation">,</span>
  lastShardId<span class="token operator">:</span> result<span class="token punctuation">.</span>shards<span class="token punctuation">,</span>
  <span class="token comment">// debug: console.log,</span>
  <span class="token function-variable function">handleDiscordPayload</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> data<span class="token punctuation">,</span> shardId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">EVENT_HANDLER_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">EVENT_HANDLER_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      headers<span class="token operator">:</span> <span class="token punctuation">{</span>
        Authorization<span class="token operator">:</span> gateway<span class="token punctuation">.</span>secretKey<span class="token punctuation">,</span>
        method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          shardId<span class="token punctuation">,</span>
          data<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// BELOW IS FOR SOLVING DENO MEMORY LEAK. Node users do your thing.</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>Basic Keys</strong></p> <ul><li><code>EVENT_HANDLER_SECRET_KEY</code> is from your configs that will be used to make sure requests sent to your event handler process are indeed from you.</li> <li><code>DISCORD_TOKEN</code> if you can't figure this out, this guide isn't for you. Please find another.</li> <li><code>intents</code> pass in a number or a string of intents. Autocomplete/type-safety is provided for strings 😃</li></ul> <p><strong>Discord Data Keys</strong>:  These keys will be the data you got from the gateway request we made earlier.</p> <ul><li><code>shardsRecommended</code></li> <li><code>sessionStartLimitTotal</code></li> <li><code>sessionStartLimitRemaining</code></li> <li><code>sessionStartLimitResetAfter</code></li> <li><code>maxConcurrency</code></li></ul> <p><strong>Powerful Keys</strong></p> <p>If your bot is going to be run on one process, you can re-use the data that discord gave you to connect.</p> <ul><li><code>maxShards</code>: is the maximum number of shards you want to use for connecting your bot. Should you think Discord is not smart enough to recommend a good amount, use this to override their choice. Highly recommend just using theirs.</li> <li><code>lastShardId</code>: is the last shard you want to connect in this process.
<ul><li>Using a combination of <code>lastShardId</code> &amp; <code>firstShardId</code>, you can create several processes or even several servers to handle different amounts of shards should your bot get that big to require horizontal scaling. You can control how many shards each gateway manager will be responsible for.</li></ul></li> <li><code>reshard</code>: Whether or not to automatically reshard the bot when necessary with zero downtime deployment strategy. Default: true.</li> <li><code>reshardPercentage</code>: The % of servers to trigger a reshard. Default: 80%.</li> <li><code>spawnShardDelay</code>: The delay in milliseconds to wait before spawning next shard. OPTIMAL IS ABOVE 2500. YOU DON&quot;T WANT TO HIT THE RATE LIMIT!!! This is mainly if you are changing internals a lot and need to modify this behavior.</li> <li><code>useOptimalLargeBotSharding</code>: Whether or not the resharder should automatically switch to LARGE BOT SHARDING when you are above 100K servers.</li> <li><code>shardsPerCluster</code>: The amount of shards to load per worker. Discussed in detail below.</li> <li><code>maxClusters</code>: The maximum amount of workers to use for your bot.</li></ul> <h4 id="gateway-cache"><a href="#gateway-cache" class="header-anchor">#</a> Gateway Cache</h4> <p>There is a few things that we cache in the gateway process directly, because sending them across the network is not ideal. This is done to support custom cache functionality.</p> <ul><li><code>guildIds</code>: Used for determining what type of GUILD_CREATE event is received.</li> <li><code>loadingGuildIds</code>: Used for determining if all guilds have arrived when initially connecting.</li> <li><code>editedMessages</code>: Used to prevent spam of events across the network. MESSAGE_UPDATE are an extremely heavy event. Any embed or link that is in a message will unfurl triggerring a message update event. This is undesired behavior for 99% of bots out there. If someone sends a message with 5 urls, in there you will get a MESSAGE_CREATE and 5 MESSAGE_UPDATE events. If that user edits a single letter on it you now get 6 MESSAGE_UPDATE events, 1 for the content change and 5 more for each url being unfurled. The editedMessages cache checks if the content of the message changed or not before sending the event downstream. Override this behavior if you need different behavior.</li></ul> <h4 id="gateway-method-overriding"><a href="#gateway-method-overriding" class="header-anchor">#</a> Gateway Method Overriding</h4> <p>One of the benefits of Discordeno is that you can override/customize anything from the library. Should you desire to change the logic in any method it is as simple as:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// TYPINGS WILL BE AUTOMATICALLY PROVIDED</span>
gateway<span class="token punctuation">.</span><span class="token function-variable function">heartbeat</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>gateway<span class="token punctuation">,</span> shardId<span class="token punctuation">,</span> interval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// YOUR CUSTOM HANDLING CODE HERE</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="handle-discord-payloads"><a href="#handle-discord-payloads" class="header-anchor">#</a> Handle Discord Payloads</h3> <p>One of the big things we didn't cover yet is the handler for discord payloads. This is the main sauce of your gateway process here. This is going to take the events that the gateway manager processed and send it to your event handler. How you wish to communicate with your event handler is up to you. For this guide, we will use http, but you can replace that with anything you like.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function-variable function">handleDiscordPayload</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> data<span class="token punctuation">,</span> shardId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// CHANGE FROM SENDING THROUGH HTTP TO USING A WS FOR FASTER PROCESSING! OR HTTP3 OR WHATEVER!</span>
    <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">EVENT_HANDLER_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">EVENT_HANDLER_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      headers<span class="token operator">:</span> <span class="token punctuation">{</span>
        Authorization<span class="token operator">:</span> gateway<span class="token punctuation">.</span>secretKey<span class="token punctuation">,</span>
        method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          shardId<span class="token punctuation">,</span>
          data<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// BELOW IS FOR SOLVING DENO MEMORY LEAK. Node users do your thing.</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>You can change this function to use a WS or any form of communication you prefer to use to send this to your event handler.</p> <h2 id="spawning-shards"><a href="#spawning-shards" class="header-anchor">#</a> Spawning Shards</h2> <p>Once you are ready and the gateway has been created as you desired, we can begin spawning the shards.</p> <div class="language-ts extra-class"><pre class="language-ts"><code>gateway<span class="token punctuation">.</span><span class="token function">spawnShards</span><span class="token punctuation">(</span>gateway<span class="token punctuation">)</span>
</code></pre></div><h2 id="workers"><a href="#workers" class="header-anchor">#</a> Workers</h2> <p>Now, we should take a minute here to talk about workers. Workers are just Clusters in Node.js</p> <p>When you have a big bot and you are processing millions of events, you need to speed up that processing. Keeping it in 1 thread is not very nice since JavaScript is single threaded. This means it can only process 1 event at a time. With workers, you can make it process several events at the same time. We mentioned the <code>shardsPerCluster</code> earlier. This option was added to allow you to choose how many shards should be managed by each worker.</p> <p>When shards are spawn they are triggered by a method on gateway.</p> <div class="language-ts extra-class"><pre class="language-ts"><code>gateway<span class="token punctuation">.</span><span class="token function-variable function">tellClusterToIdentify</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span>gateway<span class="token punctuation">,</span> workerId<span class="token punctuation">,</span> shardId<span class="token punctuation">,</span> bucketId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> gateway<span class="token punctuation">.</span><span class="token function">identify</span><span class="token punctuation">(</span>gateway<span class="token punctuation">,</span> shardId<span class="token punctuation">,</span> gateway<span class="token punctuation">.</span>maxShards<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You can choose to replace the handler with any desired functionality you like. For example, should should you want to create a new worker for each new workerId that appears and have that worker trigger the identify functionaly. How you choose to handler workers is left in your care.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/discordeno/guide/edit/main/src/bigbots/gateway.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/1/2022, 2:41:05 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/bigbots/rest.html" class="prev">
        Step 1: Creating A Standalone REST Process
      </a></span> <span class="next"><a href="/bigbots/cache.html">
        Step 3: Standalone Cache Process
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.aaff8819.js" defer></script><script src="/assets/js/2.249f7f8d.js" defer></script><script src="/assets/js/19.a2ebbb7a.js" defer></script>
  </body>
</html>
